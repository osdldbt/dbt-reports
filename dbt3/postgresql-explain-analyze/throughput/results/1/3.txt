BEGIN;
BEGIN
explain (analyze, buffers)
select
	l_orderkey,
	sum(l_extendedprice * (1 - l_discount)) as revenue,
	o_orderdate,
	o_shippriority
from
	customer,
	orders,
	lineitem
where
	c_mktsegment = 'FURNITURE'
	and c_custkey = o_custkey
	and l_orderkey = o_orderkey
	and o_orderdate < date '1995-03-10'
	and l_shipdate > date '1995-03-10'
group by
	l_orderkey,
	o_orderdate,
	o_shippriority
order by
	revenue desc,
	o_orderdate
LIMIT 10;
                                                                                                             QUERY PLAN                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=2780236.34..2780236.37 rows=10 width=48) (actual time=34139.499..35141.859 rows=10 loops=1)
   Buffers: shared hit=1320 read=1424494 written=568, temp read=211873 written=212169
   ->  Sort  (cost=2780236.34..2788152.74 rows=3166560 width=48) (actual time=34139.497..35141.854 rows=10 loops=1)
         Sort Key: (sum((lineitem.l_extendedprice * ('1'::numeric - lineitem.l_discount)))) DESC, orders.o_orderdate
         Sort Method: top-N heapsort  Memory: 26kB
         Buffers: shared hit=1320 read=1424494 written=568, temp read=211873 written=212169
         ->  Finalize GroupAggregate  (cost=2295076.12..2711808.12 rows=3166560 width=48) (actual time=33308.957..35069.908 rows=113439 loops=1)
               Group Key: lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority
               Buffers: shared hit=1317 read=1424494 written=568, temp read=211873 written=212169
               ->  Gather Merge  (cost=2295076.12..2639241.12 rows=2638800 width=48) (actual time=33308.940..34849.823 rows=113447 loops=1)
                     Workers Planned: 2
                     Workers Launched: 2
                     Buffers: shared hit=1317 read=1424494 written=568, temp read=211873 written=212169
                     ->  Partial GroupAggregate  (cost=2294076.10..2333658.10 rows=1319400 width=48) (actual time=33278.238..33464.355 rows=37816 loops=3)
                           Group Key: lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority
                           Buffers: shared hit=1317 read=1424494 written=568, temp read=211873 written=212169
                           ->  Sort  (cost=2294076.10..2297374.60 rows=1319400 width=28) (actual time=33278.207..33300.012 rows=99692 loops=3)
                                 Sort Key: lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority
                                 Sort Method: external merge  Disk: 3848kB
                                 Buffers: shared hit=1317 read=1424494 written=568, temp read=211873 written=212169
                                 Worker 0:  Sort Method: external merge  Disk: 4024kB
                                 Worker 1:  Sort Method: external merge  Disk: 3704kB
                                 ->  Parallel Hash Join  (cost=410916.68..2096809.52 rows=1319400 width=28) (actual time=30240.334..33144.715 rows=99692 loops=3)
                                       Hash Cond: (lineitem.l_orderkey = orders.o_orderkey)
                                       Buffers: shared hit=1271 read=1424494 written=568, temp read=210426 written=210716
                                       ->  Parallel Seq Scan on lineitem  (cost=0.00..1469148.05 rows=13462742 width=20) (actual time=0.061..15938.411 rows=10819470 loops=3)
                                             Filter: (l_shipdate > '1995-03-10'::date)
                                             Rows Removed by Filter: 9175640
                                             Buffers: shared hit=1196 read=1155135 written=139
                                       ->  Parallel Hash  (cost=400259.21..400259.21 rows=613078 width=16) (actual time=6476.235..6476.242 rows=484093 loops=3)
                                             Buckets: 131072  Batches: 32  Memory Usage: 3232kB
                                             Buffers: shared hit=51 read=269359 written=429, temp read=39690 written=46100
                                             ->  Parallel Hash Join  (cost=9857.75..400259.21 rows=613078 width=16) (actual time=5112.497..6240.245 rows=484093 loops=3)
                                                   Hash Cond: (orders.o_custkey = customer.c_custkey)
                                                   Buffers: shared hit=51 read=269359 written=429, temp read=39690 written=39716
                                                   ->  Parallel Seq Scan on orders  (cost=0.00..346515.67 rows=3025052 width=20) (actual time=0.071..3328.583 rows=2419462 loops=3)
                                                         Filter: (o_orderdate < '1995-03-10'::date)
                                                         Rows Removed by Filter: 2580538
                                                         Buffers: shared read=268320 written=53
                                                   ->  Parallel Hash  (cost=7779.32..7779.32 rows=126675 width=4) (actual time=180.437..180.439 rows=99832 loops=3)
                                                         Buckets: 131072  Batches: 4  Memory Usage: 4032kB
                                                         Buffers: shared hit=29 read=1039 written=376, temp written=672
                                                         ->  Parallel Index Only Scan using customer_c_mktsegment_c_custkey_idx on customer  (cost=0.43..7779.32 rows=126675 width=4) (actual time=0.096..77.576 rows=99832 loops=3)
                                                               Index Cond: (c_mktsegment = 'FURNITURE'::bpchar)
                                                               Heap Fetches: 0
                                                               Buffers: shared hit=29 read=1039 written=376
 Planning:
   Buffers: shared hit=505 read=80 written=28
 Planning Time: 4.727 ms
 Execution Time: 35145.602 ms
(50 rows)

COMMIT;
COMMIT
