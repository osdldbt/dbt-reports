BEGIN;
BEGIN
explain (analyze, buffers)
select
	nation,
	o_year,
	sum(amount) as sum_profit
from
	(
		select
			n_name as nation,
			extract(year from o_orderdate) as o_year,
			l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity as amount
		from
			part,
			supplier,
			lineitem,
			partsupp,
			orders,
			nation
		where
			s_suppkey = l_suppkey
			and ps_suppkey = l_suppkey
			and ps_partkey = l_partkey
			and p_partkey = l_partkey
			and o_orderkey = l_orderkey
			and s_nationkey = n_nationkey
			and p_name like '%midnight%'
	) as profit
group by
	nation,
	o_year
order by
	nation,
	o_year desc;
                                                                                                      QUERY PLAN                                                                                                       
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize GroupAggregate  (cost=1151891.85..1151905.69 rows=103 width=90) (actual time=89912.265..94212.017 rows=175 loops=1)
   Group Key: nation.n_name, (EXTRACT(year FROM orders.o_orderdate))
   Buffers: shared hit=21180415 read=6620966 dirtied=6951 written=384747, temp read=47986 written=48120
   ->  Gather Merge  (cost=1151891.85..1151903.28 rows=86 width=90) (actual time=89886.997..94209.907 rows=525 loops=1)
         Workers Planned: 2
         Workers Launched: 2
         Buffers: shared hit=21180415 read=6620966 dirtied=6951 written=384747, temp read=47986 written=48120
         ->  Partial GroupAggregate  (cost=1150891.83..1150893.33 rows=43 width=90) (actual time=89775.726..93570.385 rows=175 loops=3)
               Group Key: nation.n_name, (EXTRACT(year FROM orders.o_orderdate))
               Buffers: shared hit=21180415 read=6620966 dirtied=6951 written=384747, temp read=47986 written=48120
               ->  Sort  (cost=1150891.83..1150891.93 rows=43 width=81) (actual time=89753.704..90993.030 rows=1091279 loops=3)
                     Sort Key: nation.n_name, (EXTRACT(year FROM orders.o_orderdate)) DESC
                     Sort Method: external merge  Disk: 71232kB
                     Buffers: shared hit=21180415 read=6620966 dirtied=6951 written=384747, temp read=47986 written=48120
                     Worker 0:  Sort Method: external merge  Disk: 72008kB
                     Worker 1:  Sort Method: external merge  Disk: 69792kB
                     ->  Hash Join  (cost=51802.10..1150890.66 rows=43 width=81) (actual time=699.837..84526.731 rows=1091279 loops=3)
                           Hash Cond: (supplier.s_nationkey = nation.n_nationkey)
                           Buffers: shared hit=21180387 read=6620966 dirtied=6951 written=384747
                           ->  Nested Loop  (cost=51800.54..1150888.85 rows=43 width=31) (actual time=699.713..82052.084 rows=1091279 loops=3)
                                 Buffers: shared hit=21180357 read=6620965 dirtied=6951 written=384747
                                 ->  Nested Loop  (cost=51800.10..1150750.32 rows=43 width=35) (actual time=699.622..46708.884 rows=1091279 loops=3)
                                       Buffers: shared hit=11372754 read=3712297 dirtied=6933 written=209135
                                       ->  Nested Loop  (cost=51799.81..1150503.10 rows=43 width=39) (actual time=699.538..35443.966 rows=1091279 loops=3)
                                             Buffers: shared hit=1671456 read=3592085 dirtied=6933 written=201802
                                             ->  Parallel Hash Join  (cost=51799.24..268418.06 rows=134656 width=18) (actual time=699.401..4436.816 rows=145351 loops=3)
                                                   Hash Cond: (partsupp.ps_partkey = part.p_partkey)
                                                   Buffers: shared read=215505 written=155
                                                   ->  Parallel Seq Scan on partsupp  (cost=0.00..207870.36 rows=3332736 width=14) (actual time=0.058..1861.289 rows=2666667 loops=3)
                                                         Buffers: shared read=174543 written=78
                                                   ->  Parallel Hash  (cost=51378.38..51378.38 rows=33669 width=4) (actual time=688.041..688.042 rows=36338 loops=3)
                                                         Buckets: 131072  Batches: 1  Memory Usage: 5344kB
                                                         Buffers: shared read=40962 written=77
                                                         ->  Parallel Seq Scan on part  (cost=0.00..51378.38 rows=33669 width=4) (actual time=0.079..646.898 rows=36338 loops=3)
                                                               Filter: ((p_name)::text ~~ '%midnight%'::text)
                                                               Rows Removed by Filter: 630329
                                                               Buffers: shared read=40962 written=77
                                             ->  Index Scan using lineitem_l_partkey_l_suppkey_l_shipdate_l_quantity_idx on lineitem  (cost=0.56..6.54 rows=1 width=33) (actual time=0.045..0.203 rows=8 loops=436052)
                                                   Index Cond: ((l_partkey = partsupp.ps_partkey) AND (l_suppkey = partsupp.ps_suppkey))
                                                   Buffers: shared hit=1671456 read=3376580 dirtied=6933 written=201647
                                       ->  Index Scan using pk_supplier on supplier  (cost=0.29..5.75 rows=1 width=8) (actual time=0.008..0.008 rows=1 loops=3273836)
                                             Index Cond: (s_suppkey = lineitem.l_suppkey)
                                             Buffers: shared hit=9701298 read=120212 written=7333
                                 ->  Index Only Scan using orders_o_orderkey_o_orderdate_idx on orders  (cost=0.43..3.22 rows=1 width=12) (actual time=0.030..0.030 rows=1 loops=3273836)
                                       Index Cond: (o_orderkey = lineitem.l_orderkey)
                                       Heap Fetches: 10858
                                       Buffers: shared hit=9807603 read=2908668 dirtied=18 written=175612
                           ->  Hash  (cost=1.25..1.25 rows=25 width=30) (actual time=0.059..0.059 rows=25 loops=3)
                                 Buckets: 1024  Batches: 1  Memory Usage: 10kB
                                 Buffers: shared hit=2 read=1
                                 ->  Seq Scan on nation  (cost=0.00..1.25 rows=25 width=30) (actual time=0.033..0.039 rows=25 loops=3)
                                       Buffers: shared hit=2 read=1
 Planning:
   Buffers: shared hit=821 read=104 written=80
 Planning Time: 23.561 ms
 Execution Time: 94236.405 ms
(56 rows)

COMMIT;
COMMIT
