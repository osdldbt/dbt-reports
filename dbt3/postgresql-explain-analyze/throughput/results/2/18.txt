BEGIN;
BEGIN
explain (analyze, buffers)
select
	c_name,
	c_custkey,
	o_orderkey,
	o_orderdate,
	o_totalprice,
	sum(l_quantity)
from
	customer,
	orders,
	lineitem
where
	o_orderkey in (
		select
			l_orderkey
		from
			lineitem
		group by
			l_orderkey having
				sum(l_quantity) > 315
	)
	and c_custkey = o_custkey
	and o_orderkey = l_orderkey
group by
	c_name,
	c_custkey,
	o_orderkey,
	o_orderdate,
	o_totalprice
order by
	o_totalprice desc,
	o_orderdate
LIMIT 100;
                                                                                                                         QUERY PLAN                                                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=4125086.23..4125086.48 rows=100 width=75) (actual time=62201.681..62467.128 rows=75 loops=1)
   Buffers: shared hit=331422 read=819750 written=202, temp read=155137 written=155459
   ->  Sort  (cost=4125086.23..4126427.43 rows=536479 width=75) (actual time=62201.679..62467.116 rows=75 loops=1)
         Sort Key: orders.o_totalprice DESC, orders.o_orderdate
         Sort Method: quicksort  Memory: 35kB
         Buffers: shared hit=331422 read=819750 written=202, temp read=155137 written=155459
         ->  Finalize GroupAggregate  (cost=4036773.74..4104582.39 rows=536479 width=75) (actual time=62201.099..62466.939 rows=75 loops=1)
               Group Key: customer.c_custkey, orders.o_orderkey
               Buffers: shared hit=331416 read=819750 written=202, temp read=155137 written=155459
               ->  Gather Merge  (cost=4036773.74..4093405.74 rows=447066 width=75) (actual time=62201.070..62466.687 rows=75 loops=1)
                     Workers Planned: 2
                     Workers Launched: 2
                     Buffers: shared hit=331416 read=819750 written=202, temp read=155137 written=155459
                     ->  Partial GroupAggregate  (cost=4035773.71..4040803.21 rows=223533 width=75) (actual time=61980.724..61980.967 rows=25 loops=3)
                           Group Key: customer.c_custkey, orders.o_orderkey
                           Buffers: shared hit=331416 read=819750 written=202, temp read=155137 written=155459
                           ->  Sort  (cost=4035773.71..4036332.55 rows=223533 width=48) (actual time=61980.688..61980.839 rows=175 loops=3)
                                 Sort Key: customer.c_custkey, orders.o_orderkey
                                 Sort Method: quicksort  Memory: 55kB
                                 Buffers: shared hit=331416 read=819750 written=202, temp read=155137 written=155459
                                 Worker 0:  Sort Method: quicksort  Memory: 42kB
                                 Worker 1:  Sort Method: quicksort  Memory: 50kB
                                 ->  Nested Loop  (cost=2946235.79..4009035.16 rows=223533 width=48) (actual time=55964.702..61980.565 rows=175 loops=3)
                                       Buffers: shared hit=331386 read=819750 written=202, temp read=155137 written=155459
                                       ->  Hash Join  (cost=2946235.23..3499049.49 rows=55892 width=51) (actual time=55964.631..61979.252 rows=25 loops=3)
                                             Hash Cond: (orders.o_orderkey = lineitem_1.l_orderkey)
                                             Buffers: shared hit=331315 read=819444 written=202, temp read=155137 written=155459
                                             ->  Parallel Hash Join  (cost=53586.36..479114.39 rows=6274375 width=43) (actual time=5058.841..8560.290 rows=5000000 loops=3)
                                                   Hash Cond: (orders.o_custkey = customer.c_custkey)
                                                   Buffers: shared hit=22 read=304983, temp read=95670 written=95992
                                                   ->  Parallel Seq Scan on orders  (cost=0.00..331866.75 rows=6274375 width=24) (actual time=0.054..2134.719 rows=5000000 loops=3)
                                                         Buffers: shared read=269123
                                                   ->  Parallel Hash  (cost=42110.38..42110.38 rows=625038 width=23) (actual time=394.745..394.746 rows=500000 loops=3)
                                                         Buckets: 65536  Batches: 32  Memory Usage: 3168kB
                                                         Buffers: shared read=35860, temp written=8020
                                                         ->  Parallel Seq Scan on customer  (cost=0.00..42110.38 rows=625038 width=23) (actual time=0.033..181.585 rows=500000 loops=3)
                                                               Buffers: shared read=35860
                                             ->  Hash  (cost=2890448.11..2890448.11 rows=134141 width=8) (actual time=50512.460..50512.462 rows=75 loops=3)
                                                   Buckets: 131072  Batches: 2  Memory Usage: 1026kB
                                                   Buffers: shared hit=331222 read=514432 written=202
                                                   ->  GroupAggregate  (cost=0.56..2889106.70 rows=134141 width=8) (actual time=1221.236..50512.155 rows=75 loops=3)
                                                         Group Key: lineitem_1.l_orderkey
                                                         Filter: (sum(lineitem_1.l_quantity) > '315'::numeric)
                                                         Rows Removed by Filter: 14999925
                                                         Buffers: shared hit=331222 read=514432 written=202
                                                         ->  Index Only Scan using lineitem_l_orderkey_l_suppkey_l_quantity_idx on lineitem lineitem_1  (cost=0.56..2581948.16 rows=60224436 width=13) (actual time=0.075..17177.460 rows=59985781 loops=3)
                                                               Heap Fetches: 775494
                                                               Buffers: shared hit=331222 read=514432 written=202
                                       ->  Index Only Scan using lineitem_l_orderkey_l_suppkey_l_quantity_idx on lineitem  (cost=0.56..7.62 rows=150 width=13) (actual time=0.043..0.045 rows=7 loops=75)
                                             Index Cond: (l_orderkey = orders.o_orderkey)
                                             Heap Fetches: 0
                                             Buffers: shared hit=71 read=306
 Planning:
   Buffers: shared hit=486 read=101
 Planning Time: 4.600 ms
 Execution Time: 62467.415 ms
(56 rows)

COMMIT;
COMMIT
